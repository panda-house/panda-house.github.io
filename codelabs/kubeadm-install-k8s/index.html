
<!doctype html>

<html>
<head>
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <meta name="theme-color" content="#4F7DC9">
  <meta charset="UTF-8">
  <title>ä½¿ç”¨kubeadméƒ¨ç½²å•èŠ‚ç‚¹Kubernetes</title>
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Code+Pro:400|Roboto:400,300,400italic,500,700|Roboto+Mono">
  <link rel="stylesheet" href="//fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://storage.googleapis.com/codelab-elements/codelab-elements.css">
  <style>
    .success {
      color: #1e8e3e;
    }
    .error {
      color: red;
    }
  </style>
</head>
<body>
  <google-codelab-analytics gaid="UA-49880327-14"></google-codelab-analytics>
  <google-codelab codelab-gaid=""
                  id="kubeadm-install-k8s"
                  title="ä½¿ç”¨kubeadméƒ¨ç½²å•èŠ‚ç‚¹Kubernetes"
                  environment="web"
                  feedback-link="https://debris.cn">
    
      <google-codelab-step label="ç¯å¢ƒå‡†å¤‡" duration="0">
        <p>ç¡®ä¿æ¯ä¸ªèŠ‚ç‚¹ä¸Š MAC åœ°å€å’Œ product_uuid çš„å”¯ä¸€æ€§</p>
<ul>
<li>ä½ å¯ä»¥ä½¿ç”¨å‘½ä»¤ <code>ip link</code> æˆ– <code>ifconfig -a</code> æ¥è·å–ç½‘ç»œæ¥å£çš„ MAC åœ°å€</li>
<li>å¯ä»¥ä½¿ç”¨ <code>sudo cat /sys/class/dmi/id/product_uuid</code> å‘½ä»¤å¯¹ product_uuid æ ¡éªŒ</li>
</ul>
<p>ä¸€èˆ¬æ¥è®²ï¼Œç¡¬ä»¶è®¾å¤‡ä¼šæ‹¥æœ‰å”¯ä¸€çš„åœ°å€ï¼Œä½†æ˜¯æœ‰äº›è™šæ‹Ÿæœºçš„åœ°å€å¯èƒ½ä¼šé‡å¤ã€‚ Kubernetesä½¿ç”¨è¿™äº›å€¼æ¥å”¯ä¸€ç¡®å®šé›†ç¾¤ä¸­çš„èŠ‚ç‚¹ã€‚ å¦‚æœè¿™äº›å€¼åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šä¸å”¯ä¸€ï¼Œå¯èƒ½ä¼šå¯¼è‡´å®‰è£…å¤±è´¥ã€‚</p>
<h2 is-upgraded>æœåŠ¡å™¨ä¿¡æ¯</h2>
<table>
<tr><td colspan="1" rowspan="1"><p>IPåœ°å€</p>
</td><td colspan="1" rowspan="1"><p>è§’è‰²</p>
</td><td colspan="1" rowspan="1"><p>CPU</p>
</td><td colspan="1" rowspan="1"><p>å†…å­˜</p>
</td><td colspan="1" rowspan="1"><p>ä¸»æœºåï¼ˆhostnameï¼‰</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>172.16.2.246</p>
</td><td colspan="1" rowspan="1"><p>master and  etcd</p>
</td><td colspan="1" rowspan="1"><p>4</p>
</td><td colspan="1" rowspan="1"><p>8</p>
</td><td colspan="1" rowspan="1"><p>k8s-master01</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>172.16.2.247</p>
</td><td colspan="1" rowspan="1"><p>work node</p>
</td><td colspan="1" rowspan="1"><p>4</p>
</td><td colspan="1" rowspan="1"><p>8</p>
</td><td colspan="1" rowspan="1"><p>k8s-work01</p>
</td></tr>
</table>
<h2 is-upgraded>è½¯ä»¶ç‰ˆæœ¬</h2>
<table>
<tr><td colspan="1" rowspan="1"><p>æ“ä½œç³»ç»Ÿ</p>
</td><td colspan="1" rowspan="1"><p>ç³»ç»Ÿå†…æ ¸ç‰ˆæœ¬</p>
</td><td colspan="1" rowspan="1"><p>Kubernetesç‰ˆæœ¬</p>
</td><td colspan="1" rowspan="1"><p>dockerç‰ˆæœ¬</p>
</td><td colspan="1" rowspan="1"><p>kubectlç‰ˆæœ¬</p>
</td><td colspan="1" rowspan="1"><p>kubeadmç‰ˆæœ¬</p>
</td><td colspan="1" rowspan="1"><p>kubeletç‰ˆæœ¬</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>CentOS7.9.2009</p>
</td><td colspan="1" rowspan="1"><p>5.10.7</p>
</td><td colspan="1" rowspan="1"><p>1.19.7</p>
</td><td colspan="1" rowspan="1"><p>19.03.9</p>
</td><td colspan="1" rowspan="1"><p>1.19.7</p>
</td><td colspan="1" rowspan="1"><p>1.19.7</p>
</td><td colspan="1" rowspan="1"><p>1.19.7</p>
</td></tr>
</table>
<aside class="warning"><p>æ³¨æ„ï¼šè¿™é‡Œé‡‡ç”¨çš„è½¯ä»¶ç‰ˆæœ¬ï¼Œè¯·å¤§å®¶ä¸¥æ ¼ä¿æŒä¸€è‡´ï¼å¼€æºè½¯ä»¶ï¼Œç‰ˆæœ¬éå¸¸æ•æ„Ÿå’Œé‡è¦ï¼ kubernetesç‰ˆæœ¬è¦æ±‚å‚è€ƒåœ°å€ï¼š<br> https://github.com/kubernetes/kubernetes/tree/master/CHANGELOG https://kubernetes.io/docs/setup/release/version-skew-policy/</p>
</aside>
<h2 is-upgraded>ç¯å¢ƒåˆå§‹åŒ–æ“ä½œ</h2>
<h3 is-upgraded>é…ç½®hostname</h3>
<p>æ ¹æ®æœåŠ¡å™¨å®é™…åç§°æ›¿æ¢<code>$master</code>ã€<code>$node</code>çš„å€¼</p>
<pre><code>hostnamectl set-hostname $master
hostnamectl set-hostname $node
</code></pre>
<aside class="warning"><p>æ³¨æ„ï¼šhostnameä¸èƒ½æœ‰å¤§å†™å­—æ¯ï¼Œè¿˜æœ‰å…¶ä»–çš„ç‰¹æ®Šç¬¦å·ï¼Œä¹Ÿä¸è¦æœ‰<code>_</code>ï¼Œå¦åˆ™åé¢åˆå§‹åŒ–ä¼šæŠ¥é”™ã€‚</p>
</aside>
<h3 is-upgraded>é…ç½®/etc/hosts</h3>
<p>æ³¨æ„ï¼Œhostsæ–‡ä»¶éå¸¸é‡è¦ ä¿®æ”¹é…ç½®æ–‡ä»¶</p>
<pre><code>vi /etc/hosts
</code></pre>
<p>æ·»åŠ ä»¥ä¸‹å†…å®¹</p>
<pre><code>172.16.2.246 k8s-master01
172.16.2.247 k8s-work01
</code></pre>
<h3 is-upgraded>å…³é—­é˜²ç«å¢™</h3>
<pre><code>systemctl stop firewalld
systemctl disable firewalld
</code></pre>
<h3 is-upgraded>å…³é—­swapåˆ†åŒº</h3>
<pre><code>swapoff -a
sed -i &#39;s/.*swap.*/#&amp;/&#39; /etc/fstab
</code></pre>
<h3 is-upgraded>å…³é—­selinux</h3>
<pre><code>setenforce  0
sed -i &#34;s/^SELINUX=enforcing/SELINUX=disabled/g&#34; /etc/sysconfig/selinux
sed -i &#34;s/^SELINUX=enforcing/SELINUX=disabled/g&#34; /etc/selinux/config
sed -i &#34;s/^SELINUX=permissive/SELINUX=disabled/g&#34; /etc/sysconfig/selinux
sed -i &#34;s/^SELINUX=permissive/SELINUX=disabled/g&#34; /etc/selinux/config  
</code></pre>
<h3 is-upgraded>åŠ è½½br_netfilter</h3>
<pre><code>modprobe br_netfilter
</code></pre>
<p>æˆ–è€…</p>
<pre><code>cat &lt;&lt;EOF | sudo tee /etc/modules-load.d/k8s.conf
br_netfilter
EOF
</code></pre>
<h3 is-upgraded>é…ç½®å†…æ ¸å‚æ•°</h3>
<pre><code>cat &gt; /etc/sysctl.d/k8s.conf &lt;&lt;EOF
net.ipv4.ip_forward = 1
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
EOF
</code></pre>
<h3 is-upgraded>ç”Ÿæ•ˆå†…æ ¸é…ç½®æ–‡ä»¶</h3>
<pre><code>sysctl -p /etc/sysctl.d/k8s.conf

</code></pre>
<h3 is-upgraded>ä¿®æ”¹Linuxèµ„æºé…ç½®æ–‡ä»¶ï¼Œè°ƒé«˜<code>ulimit</code>æœ€å¤§æ‰“å¼€æ•°å’Œsystemctlç®¡ç†çš„æœåŠ¡æ–‡ä»¶æœ€å¤§æ‰“å¼€æ•°</h3>
<pre><code>echo &#34;* soft nofile 655360&#34; &gt;&gt; /etc/security/limits.conf
echo &#34;* hard nofile 655360&#34; &gt;&gt; /etc/security/limits.conf
echo &#34;* soft nproc 655360&#34;  &gt;&gt; /etc/security/limits.conf
echo &#34;* hard nproc 655360&#34;  &gt;&gt; /etc/security/limits.conf
echo &#34;* soft  memlock  unlimited&#34;  &gt;&gt; /etc/security/limits.conf
echo &#34;* hard memlock  unlimited&#34;  &gt;&gt; /etc/security/limits.conf
echo &#34;DefaultLimitNOFILE=1024000&#34;  &gt;&gt; /etc/systemd/system.conf 
echo &#34;DefaultLimitNPROC=1024000&#34;  &gt;&gt; /etc/systemd/system.conf
</code></pre>
<h3 is-upgraded>é…ç½®k8sä»‹è´¨yumæº</h3>
<pre><code>cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo
[kubernetes]
name=Kubernetes
baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/
enabled=1
gpgcheck=1
repo_gpgcheck=1
gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
EOF
</code></pre>
<h3 is-upgraded>å®‰è£…ä¾èµ–è½¯ä»¶åŒ…</h3>
<pre><code>yum install  -y conntrack ipvsadm ipset jq sysstat curl iptables libseccomp bash-completion yum-utils device-mapper-persistent-data lvm2 net-tools conntrack-tools vim libtool-ltdl
</code></pre>
<h3 is-upgraded>æ—¶é—´åŒæ­¥é…ç½®</h3>
<p>Kubernetesæ˜¯åˆ†å¸ƒå¼çš„ï¼Œå„ä¸ªèŠ‚ç‚¹ç³»ç»Ÿæ—¶é—´éœ€è¦åŒæ­¥å¯¹åº”ä¸Šã€‚</p>
<pre><code>yum install chrony â€“y
systemctl enable chronyd.service &amp;&amp; systemctl start chronyd.service &amp;&amp; systemctl status chronyd.service
chronyc sources
</code></pre>
<h3 is-upgraded>é…ç½®èŠ‚ç‚¹é—´sshäº’ä¿¡</h3>
<p>é…ç½®sshäº’ä¿¡ï¼Œé‚£ä¹ˆèŠ‚ç‚¹ä¹‹é—´å°±èƒ½æ— å¯†è®¿é—®ï¼Œæ–¹ä¾¿æ—¥åæ‰§è¡Œè‡ªåŠ¨åŒ–éƒ¨ç½². æ¯å°æœºå™¨æ‰§è¡Œè¿™ä¸ªå‘½ä»¤ï¼Œä¸€è·¯å›è½¦å³å¯</p>
<pre><code>ssh-keygen 
</code></pre>
<p>å°†masterä¸Šçš„å…¬é’¥æ‹·è´åˆ°å…¶ä»–èŠ‚ç‚¹ï¼Œæ›¿æ¢<code>node</code>åç§°,è¿™é‡Œéœ€è¦åŒæ„è¾“å…¥yeså’Œå¯†ç </p>
<pre><code>ssh-copy-id  $node      
</code></pre>
<h3 is-upgraded>åˆå§‹åŒ–ç¯å¢ƒé…ç½®æ£€æŸ¥</h3>
<ul>
<li>é‡å¯ï¼Œåšå®Œä»¥ä¸Šæ‰€æœ‰æ“ä½œï¼Œæœ€å¥½rebooté‡å¯ä¸€é</li>
<li>ping æ¯ä¸ªèŠ‚ç‚¹hostname çœ‹æ˜¯å¦èƒ½pingé€š</li>
<li>ssh å¯¹æ–¹hostnameçœ‹äº’ä¿¡æ˜¯å¦æ— å¯†ç è®¿é—®æˆåŠŸ</li>
<li>æ‰§è¡Œdateå‘½ä»¤æŸ¥çœ‹æ¯ä¸ªèŠ‚ç‚¹æ—¶é—´æ˜¯å¦æ­£ç¡®</li>
<li>æ‰§è¡Œ ulimit -Hn çœ‹ä¸‹æœ€å¤§æ–‡ä»¶æ‰“å¼€æ•°æ˜¯å¦æ˜¯655360</li>
<li>cat /etc/sysconfig/selinux |grep disabled æŸ¥çœ‹ä¸‹æ¯ä¸ªèŠ‚ç‚¹selinuxæ˜¯å¦éƒ½æ˜¯disabledçŠ¶æ€</li>
</ul>


      </google-codelab-step>
    
      <google-codelab-step label="dockerå®‰è£…" duration="0">
        <p>å‚è€ƒï¼š<a href="https://pandahoues.github.io/codelabs/Container-install" target="_blank">dockerå®‰è£…</a></p>


      </google-codelab-step>
    
      <google-codelab-step label="å®‰è£…kubeadmç­‰å·¥å…·" duration="0">
        <p>è¿™ä¸€æ­¥æ˜¯æ‰€æœ‰èŠ‚ç‚¹éƒ½å¾—å®‰è£…ï¼ˆåŒ…æ‹¬nodeèŠ‚ç‚¹ï¼‰ï¼Œå¯ä»¥ å·¥å…·è¯´æ˜ï¼š</p>
<ul>
<li>kubeadm: éƒ¨ç½²é›†ç¾¤ç”¨çš„å‘½ä»¤</li>
<li>kubelet: åœ¨é›†ç¾¤ä¸­æ¯å°æœºå™¨ä¸Šéƒ½è¦è¿è¡Œçš„ç»„ä»¶ï¼Œè´Ÿè´£ç®¡ç†podã€å®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸ</li>
<li>kubectl: é›†ç¾¤ç®¡ç†å·¥å…·</li>
</ul>
<h2 is-upgraded>å®‰è£…å·¥å…·</h2>
<p>æŸ¥è¯¢kubeç³»åˆ—å·¥å…·çš„ç‰ˆæœ¬å·</p>
<pre><code>yum list `kubeadm` --showduplicates | sort -r`
</code></pre>
<p>å®‰è£…kubeç³»åˆ—å·¥å…·</p>
<pre><code>yum install -y kubelet-1.19.7 kubeadm-1.19.7 kubectl-1.19.7 --disableexcludes=kubernetes
</code></pre>
<h2 is-upgraded>å¯åŠ¨kubelet</h2>
<pre><code>systemctl enable kubelet &amp;&amp; systemctl start kubelet
systemctl enable --now kubelet
</code></pre>
<aside class="warning"><p>æç¤ºï¼šæ­¤æ—¶kubeletçš„æœåŠ¡è¿è¡ŒçŠ¶æ€æ˜¯å¼‚å¸¸çš„ï¼Œå› ä¸ºç¼ºå°‘ä¸»é…ç½®æ–‡ä»¶kubelet.confã€‚ä½†å¯ä»¥æš‚ä¸å¤„ç†ï¼Œå› ä¸ºåœ¨å®ŒæˆMasterèŠ‚ç‚¹çš„åˆå§‹åŒ–åæ‰ä¼šç”Ÿæˆè¿™ä¸ªé…ç½®æ–‡ä»¶ã€‚</p>
</aside>


      </google-codelab-step>
    
      <google-codelab-step label="é•œåƒä¸‹è½½å‡†å¤‡" duration="0">
        <h2 is-upgraded>æŸ¥è¯¢é•œåƒåˆ—è¡¨</h2>
<pre><code>kuebeadm config  images list
</code></pre>
<h2 is-upgraded>ç”Ÿæˆé»˜è®¤<code>kubeadm.conf</code>æ–‡ä»¶</h2>
<pre><code>kubeadm config print init-defaults &gt; kubeadm.conf      
</code></pre>
<h2 is-upgraded>ç»•è¿‡å¢™ä¸‹è½½é•œåƒæ–¹æ³•ï¼ˆæ³¨æ„è®¤çœŸçœ‹ï¼ŒåæœŸç‰ˆæœ¬å®‰è£…ä¹Ÿå¯ä»¥å¥—ç”¨è¿™æ–¹æ³•ï¼‰</h2>
<p>æ³¨æ„è¿™ä¸ªé…ç½®æ–‡ä»¶é»˜è®¤ä¼šä»googleçš„é•œåƒä»“åº“åœ°å€k8s.gcr.ioä¸‹è½½é•œåƒï¼Œå¦‚æœä½ æ²¡æœ‰ç§‘å­¦ä¸Šç½‘ï¼Œé‚£ä¹ˆå°±ä¼šä¸‹è½½ä¸æ¥ã€‚å› æ­¤ï¼Œæˆ‘ä»¬é€šè¿‡ä¸‹é¢çš„æ–¹æ³•æŠŠåœ°å€æ”¹æˆå›½å†…çš„ï¼Œæ¯”å¦‚ç”¨é˜¿é‡Œçš„ã€‚</p>
<p>æ›¿æ¢é•œåƒä»“åº“åœ°å€</p>
<pre><code>sed -i &#39;s!imageRepository: k8s.gcr.io!imageRepository: registry.aliyuncs.com/google_containers!g&#39; kubeadm.conf
</code></pre>
<p>æ›¿æ¢ç‰ˆæœ¬å·</p>
<pre><code>sed -i &#34;s/kubernetesVersion: .*/kubernetesVersion: v1.19.7/g&#34; kubeadm.conf
</code></pre>
<p>ä¸‹è½½é•œåƒ</p>
<pre><code>kubeadm config images pull --config kubeadm.conf
</code></pre>
<p>ä¿®æ”¹é•œåƒå‰ç¼€è„šæœ¬ é€šè¿‡è„šæœ¬å°†<code>registry.aliyuncs.com</code>å¼€å¤´çš„é•œåƒé‡å‘½åä¸º<code>k8s.gcr.io</code>ï¼Œæˆ–è€…æ‰‹åŠ¨é€šè¿‡<code>docker tag</code>å‘½ä»¤ã€‚è¿™æ ·å®‰è£…ç¨‹åºæ‰èƒ½è¯†åˆ«åˆ°ã€‚</p>
<pre><code>vi image-rename.sh
</code></pre>
<p>æ·»åŠ ä»¥ä¸‹å†…å®¹</p>
<pre><code>#!/bin/bash
images=(kube-apiserver:v1.19.7 kube-controller-manager:v1.19.7 kube-scheduler:v1.19.7 kube-proxy:v1.19.7
pause:3.2 etcd:3.4.13-0 coredns:1.7.0)
for imageName in ${images[@]} ; do
  docker tag registry.aliyuncs.com/google_containers/$imageName k8s.gcr.io/$imageName
  docker rmi registry.aliyuncs.com/google_containers/$imageName
done
</code></pre>
<p>æ£€æŸ¥é•œåƒ</p>
<pre><code>docker image ls 
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="éƒ¨ç½²masterèŠ‚ç‚¹" duration="0">
        <h2 is-upgraded><code>kubeadm init</code>åˆå§‹åŒ–masterèŠ‚ç‚¹</h2>
<pre><code>kubeadm init --kubernetes-version=v1.19.7 --pod-network-cidr=192.168.0.0/16 --apiserver-advertise-address=172.16.2.246
</code></pre>
<aside class="special"><p>è¿™é‡Œæˆ‘ä»¬å®šä¹‰PODçš„ç½‘æ®µä¸º: 192.168.0.0/16 ,ç„¶åapi serveråœ°å€å°±æ˜¯masteræœ¬æœºIPåœ°å€ã€‚</p>
</aside>
<p>åˆå§‹åŒ–æˆåŠŸåï¼Œ/etc/kubernetes/ ä¼šç”Ÿæˆä¸‹é¢æ–‡ä»¶,åŒæ—¶æœ€åä¼šç”Ÿæˆä¸€å¥è¯,è¿™ä¸ªæˆ‘ä»¬è®°å½•ä¸‹,åˆ°æ—¶å€™æ·»åŠ nodeçš„æ—¶å€™è¦ç”¨åˆ°ã€‚</p>
<pre><code>kubeadm join 172.16.2.246:6443 --token osvv1g.7hlo28nnvgdcodiu \
    --discovery-token-ca-cert-hash sha256:a19172e1f2e029b742a8c74391522fc241fde587f511e098abd17aad39c95176
</code></pre>
<h2 is-upgraded>éªŒè¯æµ‹è¯•</h2>
<p>é…ç½®kubectlå‘½ä»¤</p>
<pre><code>mkdir -p /root/.kube
cp /etc/kubernetes/admin.conf /root/.kube/config
</code></pre>
<p>æ‰§è¡Œè·å–podsåˆ—è¡¨å‘½ä»¤ï¼ŒæŸ¥çœ‹ç›¸å…³çŠ¶æ€</p>
<pre><code>kubectl get pods --all-namespaces
</code></pre>
<p>åœ¨å®‰è£…ç½‘ç»œä¹‹å‰,é›†ç¾¤<code>DNS (CoreDNS)</code>å°†ä¸ä¼šå¯åŠ¨,å¤„äºPendingçŠ¶æ€ï¼Œè¿™ä¸ªå…ˆä¸ç®¡ã€‚ æˆ‘ä»¬å¯ä»¥æ‰§è¡Œ<code>kubectl get cs</code>æŸ¥çœ‹é›†ç¾¤çš„å¥åº·çŠ¶æ€ï¼Œä¼šçœ‹åˆ°é›†ç¾¤æœ‰<code>unhealthy</code>çš„çŠ¶æ€ï¼Œå‡ºç°è¿™ç§æƒ…å†µæ˜¯kube-controller-manager.yamlå’Œkube-scheduler.yamlè®¾ç½®çš„é»˜è®¤ç«¯å£æ˜¯0ï¼Œåœ¨æ–‡ä»¶ä¸­æ³¨é‡Šæ‰å°±å¯ä»¥äº†ã€‚ï¼ˆæ¯å°masterèŠ‚ç‚¹éƒ½è¦æ‰§è¡Œæ“ä½œï¼‰ <img alt="-w1092" src="img/119ad091c1484a32.jpg"></p>
<h2 is-upgraded>ä¿®æ”¹kube-scheduler.yamlæ–‡ä»¶,æ³¨é‡Š<code>port=0</code>æ‰€åœ¨è¡Œ</h2>
<p><code>vim /etc/kubernetes/manifests/kube-scheduler.yaml</code> å‚è€ƒå†…å®¹å¦‚ä¸‹:</p>
<pre><code>apiVersion: v1
kind: Pod
metadata:
  creationTimestamp: null
  labels:
    component: kube-scheduler
    tier: control-plane
  name: kube-scheduler
  namespace: kube-system
spec:
  containers:
  - command:
    - kube-scheduler
    - --authentication-kubeconfig=/etc/kubernetes/scheduler.conf
    - --authorization-kubeconfig=/etc/kubernetes/scheduler.conf
    - --bind-address=127.0.0.1
    - --kubeconfig=/etc/kubernetes/scheduler.conf
    - --leader-elect=true
#    - --port=0
    image: k8s.gcr.io/kube-scheduler:v1.19.7
    imagePullPolicy: IfNotPresent
    livenessProbe:
      failureThreshold: 8
      httpGet:
        host: 127.0.0.1
        path: /healthz
        port: 10259
        scheme: HTTPS
      initialDelaySeconds: 10
      ç•¥...
</code></pre>
<h2 is-upgraded>ä¿®æ”¹kube-controller-manager.yamlæ–‡ä»¶ï¼Œæ³¨é‡Š<code>port=0</code>æ‰€åœ¨è¡Œ</h2>
<p><code>vim /etc/kubernetes/manifests/kube-controller-manager.yaml</code> å‚è€ƒå†…å®¹å¦‚ä¸‹:</p>
<pre><code>apiVersion: v1
kind: Pod
metadata:
  creationTimestamp: null
  labels:
    component: kube-controller-manager
    tier: control-plane
  name: kube-controller-manager
  namespace: kube-system
spec:
  containers:
  - command:
    - kube-controller-manager
    - --allocate-node-cidrs=true
    - --authentication-kubeconfig=/etc/kubernetes/controller-manager.conf
    - --authorization-kubeconfig=/etc/kubernetes/controller-manager.conf
    - --bind-address=127.0.0.1
    - --client-ca-file=/etc/kubernetes/pki/ca.crt
    - --cluster-cidr=192.168.10.0/24
    - --cluster-name=kubernetes
    - --cluster-signing-cert-file=/etc/kubernetes/pki/ca.crt
    - --cluster-signing-key-file=/etc/kubernetes/pki/ca.key
    - --controllers=*,bootstrapsigner,tokencleaner
    - --kubeconfig=/etc/kubernetes/controller-manager.conf
    - --leader-elect=true
    - --node-cidr-mask-size=24
#    - --port=0
    - --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.crt
    - --root-ca-file=/etc/kubernetes/pki/ca.crt
    - --service-account-private-key-file=/etc/kubernetes/pki/sa.key
    - --service-cluster-ip-range=10.96.0.0/12
    - --use-service-account-credentials=true
    image: k8s.gcr.io/kube-controller-manager:v1.19.7
    imagePullPolicy: IfNotPresent
    livenessProbe:
      failureThreshold: 8
      httpGet:
        host: 127.0.0.1
        path: /healthz
        port: 10257
        scheme: HTTPS
      initialDelaySeconds: 10
      periodSeconds: 10
      ç•¥...
</code></pre>
<p>æ¯å°masteré‡å¯kubelet</p>
<pre><code>systemctl restart kubelet
</code></pre>
<p>å†æ¬¡æŸ¥çœ‹çŠ¶æ€</p>
<pre><code>kubectl get cs
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="éƒ¨ç½²ç½‘ç»œæ’ä»¶" duration="0">
        <p>ç½‘ç»œæ’ä»¶ç°åœ¨æœ‰<code>flannel</code>ã€<code>calico</code>ç­‰,æˆ‘ä»¬æ­¤æ¬¡é‡‡ç”¨<code>Flannel</code></p>
<aside class="warning"><p>calicoæœ‰2ç§ä¸­ä½œæ¨¡å¼: ipip(éš§é“æ–¹æ¡ˆ)ã€bgp(è·¯ç”±æ–¹æ¡ˆ),æ‰€ä»¥å…¬æœ‰äº‘<code>å</code>¯èƒ½ä¼šå¯¹è·¯ç”±æ–¹æ¡ˆé€ æˆå½±å“,å¹¶ä¸”æœ‰çš„äº‘ä¸»æœºä¼šç¦æ­¢è·¯ç”±(bgp)æ–¹æ¡ˆ,æ‰€ä»¥æœ‰äº›äº‘å‚å•†æ˜¯ç¦æ­¢æ­¤å®ç°æ–¹å¼çš„,å› ä¸ºä»–ä¼šå†™å…¥è·¯ç”±è¡¨,è¿™æ ·å¯èƒ½ä¼šå½±å“åˆ°å‚å•†ç°æœ‰ç½‘ç»œ,è¿™ä¸ªéœ€åˆ°ä½ è‡ªå·±çš„ç¯å¢ƒå®æµ‹æ‰èƒ½ç™¾åˆ†ç™¾ç¡®è®¤ã€‚</p>
</aside>
<h2 is-upgraded>å®‰è£…<code>Flannel</code></h2>
<pre><code>kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
</code></pre>
<h2 is-upgraded>æ£€æŸ¥çŠ¶æ€</h2>
<pre><code>kubectl get pods --all-namespaces
</code></pre>


      </google-codelab-step>
    
  </google-codelab>

  <script src="https://storage.googleapis.com/codelab-elements/native-shim.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/custom-elements.min.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/prettify.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/codelab-elements.js"></script>
  <script src="//support.google.com/inapp/api.js"></script>

</body>
</html>
